@using Klimaci.DTO.ProjectDTOs
@using Klimaci.Entity

@model ProjectAddDTO
@{
    ViewData["Title"] = "Yeni Proje";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    var brands = (IEnumerable<Brand>)(ViewBag.Brands ?? Enumerable.Empty<Brand>());
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

<div class="container py-3">
    <h1>Yeni Proje</h1>
    @await Html.PartialAsync("~/Areas/Admin/Views/Shared/_AdminAlerts.cshtml")

    <form asp-action="Create" method="post" enctype="multipart/form-data" class="vstack gap-3">
        <div class="row g-3">
            <div class="col-lg-8">
                <div class="mb-2">
                    <label class="form-label">Başlık</label>
                    <input asp-for="Title" class="form-control" id="title" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Açıklama</label>
                    <textarea asp-for="Description" rows="6" class="form-control"></textarea>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Şehir</label>
                        <input asp-for="City" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tamamlanma</label>
                        <input asp-for="CompletedAt" type="date" class="form-control" />
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="mb-2">
                    <label class="form-label">Marka</label>
                    <select asp-for="BrandId" class="form-select">
                        <option value="">Seçiniz</option>
                        @foreach (var b in brands)
                        {
                            <option value="@b.Id">@b.Title</option>
                        }
                    </select>
                </div>

                <div class="mb-2">
                    <label class="form-label">Slug (boşsa otomatik)</label>
                    <div class="input-group">
                        <input asp-for="Slug" class="form-control" id="slug" />
                        <button type="button" class="btn btn-outline-secondary" id="btnSlug">Kontrol</button>
                    </div>
                    <div class="form-text" id="slugHint"></div>
                </div>

                <div class="mb-2">
                    <label class="form-label">SEO Title</label>
                    <input asp-for="SeoTitle" class="form-control" />
                </div>
                <div class="mb-2">
                    <label class="form-label">SEO Description</label>
                    <textarea asp-for="SeoDescription" rows="2" class="form-control"></textarea>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label">Sıra</label>
                        <input asp-for="DisplayOrder" class="form-control" />
                    </div>
                    <div class="col-6 d-flex align-items-end">
                        <div class="form-check">
                            <input class="form-check-input" asp-for="IsPublished" />
                            <label class="form-check-label" for="IsPublished">Yayında</label>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="form-label">Görseller</label>
                    <input type="file" name="files" multiple class="form-control" />
                    <div class="form-text">İlk görsel kapak kabul edilir. Kapak seçimini sonra ekleriz.</div>
                </div>
            </div>
        </div>

        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-primary">Kaydet</button>
            <a asp-action="Index" class="btn btn-light">Geri</a>
        </div>
        @Html.AntiForgeryToken()
    </form>
</div>

@section Scripts {
    <script>
        async function slugCheck() {
          const title = document.getElementById('title').value || '';
          const slug  = document.getElementById('slug').value || '';
          const res = await fetch('@Url.Action("SlugCheck")', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ title, slug, excludeId: null })
          });
          const data = await res.json();
          const input = document.getElementById('slug');
          const hint = document.getElementById('slugHint');
          input.value = data.finalSlug || data.FinalSlug;
          const ok = data.isUnique ?? data.IsUnique;
          hint.textContent = ok ? 'Uygun.' : 'Çakışma vardı, düzeltildi.';
          hint.className = ok ? 'form-text text-success' : 'form-text text-warning';
        }
        document.getElementById('btnSlug').addEventListener('click', slugCheck);
        document.getElementById('title').addEventListener('blur', ()=>{ if(!document.getElementById('slug').value) slugCheck(); });
    </script>
}
